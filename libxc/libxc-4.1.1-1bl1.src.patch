diff -buprN -x CYGWIN-PATCHES -x aclocal.m4~ -x aclocal.m4t -x autom4te.cache -x config.cache -x config.guess -x config.log -x config.status -x config.sub -x '*SlackBuild*' -x '*.egg-info' -x '*.dll' -x '*.exe' -x '*.o' -x '*.gch' -x '*.gem' -x .gitignore -x '*.jpg' -x '*.png' -x '*.qm' -x '*.svgz' -x '*.tif' -x '*.class' -x '*.jlc' -x '*.pyc' -x '*.pyo' -x '*.mo' -x '*.gmo' -x '*.orig' -x '*.rej' -x '*.spec' -x '*.temp' -x '*~' -x '*.stackdump' -x x86_64-pc-cygwin -x aclocal.m4 -x configure -x config.h -x '*.h.in' -x COPYING -x INSTALL -x ansi2knr.c -x ar-lib -x config-ml.in -x elisp-comp -x mdate-sh -x mkinstalldirs -x py-compile -x symlink-tree -x test-driver -x texinfo.tex -x ylwrap -x Makefile.in -x GNUmakefile.in -x makefile.in -x libtool.m4 -x ltoptions.m4 -x ltsugar.m4 -x ltversion.m4 -x lt~obsolete.m4 -x ltmain.sh -x compile -x depcomp -x install-sh -x missing -x omf.make -x xmldocs.make -x gnome-doc-utils.make -x gnome-doc-utils.m4 -x mate-doc-utils.make -x mate-doc-utils.m4 origsrc/libxc-4.1.1-c51bdeca70eb3a74ba99f6d1ef8adb4fb2f2a0de/src/Makefile.am src/libxc-4.1.1-c51bdeca70eb3a74ba99f6d1ef8adb4fb2f2a0de/src/Makefile.am
--- origsrc/libxc-4.1.1-c51bdeca70eb3a74ba99f6d1ef8adb4fb2f2a0de/src/Makefile.am	2018-05-09 16:45:21.000000000 +0900
+++ src/libxc-4.1.1-c51bdeca70eb3a74ba99f6d1ef8adb4fb2f2a0de/src/Makefile.am	2018-05-21 09:46:05.835608600 +0900
@@ -92,7 +92,7 @@ libxc_la_FUNC_SOURCES = \
         mgga_c_revscan.c mgga_x_br89_explicit.c
 
 libxc_la_SOURCES = references.c $(libxc_la_FUNC_SOURCES)
-libxc_la_LDFLAGS = -version-info $(XC_LT_VERSION)
+libxc_la_LDFLAGS = -no-undefined -version-info $(XC_LT_VERSION)
 
 if COMPILE_FORTRAN
   lib_LTLIBRARIES += libxcf90.la
@@ -101,11 +101,8 @@ if COMPILE_FORTRAN
   nodist_libxcf90_la_SOURCES = libxc_funcs.f90 libxc.f90
 
   # libtool stuff
-  libxcf90_la_LDFLAGS = -version-info $(XC_LT_VERSION)
+  libxcf90_la_LDFLAGS = -no-undefined -version-info $(XC_LT_VERSION)
   libxcf90_la_LIBADD = libxc.la
-
-  # this is a hack to go around buggy libtool/automake versions
-  libxcf90_la_LIBTOOLFLAGS = --tag=F77
 endif
 
 if COMPILE_FORTRAN03
@@ -114,19 +111,10 @@ if COMPILE_FORTRAN03
   nodist_libxcf03_la_SOURCES = libxcf03.f90
 
   # libtool stuff
-  libxcf03_la_LDFLAGS = -version-info $(XC_LT_VERSION)
+  libxcf03_la_LDFLAGS = -no-undefined -version-info $(XC_LT_VERSION)
   libxcf03_la_LIBADD = libxc.la
-
-  # this is a hack to go around buggy libtool/automake versions
-  libxcf03_la_LIBTOOLFLAGS = --tag=F77
 endif
 
-
-# this is a hack to go around buggy libtool/automake versions
-LTFCCOMPILE = $(LIBTOOL) --mode=compile --tag=F77 $(FC) $(AM_FCFLAGS) $(FCFLAGS)
-FCLINK = $(LIBTOOL) --mode=link --tag=F77 $(FCLD) $(AM_FCFLAGS) $(FCFLAGS) \
-         $(AM_LDFLAGS) $(LDFLAGS) -o $@
-
 noinst_HEADERS = \
 	string_f.h references.h util.h work_lda.c \
 	work_gga_x.c work_gga_c.c \
diff -buprN -x CYGWIN-PATCHES -x aclocal.m4~ -x aclocal.m4t -x autom4te.cache -x config.cache -x config.guess -x config.log -x config.status -x config.sub -x '*SlackBuild*' -x '*.egg-info' -x '*.dll' -x '*.exe' -x '*.o' -x '*.gch' -x '*.gem' -x .gitignore -x '*.jpg' -x '*.png' -x '*.qm' -x '*.svgz' -x '*.tif' -x '*.class' -x '*.jlc' -x '*.pyc' -x '*.pyo' -x '*.mo' -x '*.gmo' -x '*.orig' -x '*.rej' -x '*.spec' -x '*.temp' -x '*~' -x '*.stackdump' -x x86_64-pc-cygwin -x aclocal.m4 -x configure -x config.h -x '*.h.in' -x COPYING -x INSTALL -x ansi2knr.c -x ar-lib -x config-ml.in -x elisp-comp -x mdate-sh -x mkinstalldirs -x py-compile -x symlink-tree -x test-driver -x texinfo.tex -x ylwrap -x Makefile.in -x GNUmakefile.in -x makefile.in -x libtool.m4 -x ltoptions.m4 -x ltsugar.m4 -x ltversion.m4 -x lt~obsolete.m4 -x ltmain.sh -x compile -x depcomp -x install-sh -x missing -x omf.make -x xmldocs.make -x gnome-doc-utils.make -x gnome-doc-utils.m4 -x mate-doc-utils.make -x mate-doc-utils.m4 origsrc/libxc-4.1.1-c51bdeca70eb3a74ba99f6d1ef8adb4fb2f2a0de/src/util.h src/libxc-4.1.1-c51bdeca70eb3a74ba99f6d1ef8adb4fb2f2a0de/src/util.h
--- origsrc/libxc-4.1.1-c51bdeca70eb3a74ba99f6d1ef8adb4fb2f2a0de/src/util.h	2018-05-09 16:45:21.000000000 +0900
+++ src/libxc-4.1.1-c51bdeca70eb3a74ba99f6d1ef8adb4fb2f2a0de/src/util.h	2018-05-21 09:46:05.851225900 +0900
@@ -65,9 +65,14 @@ double erf(double);
 double erfc(double);
 #endif
 
-
+#if defined(M_SQRTPI)
+#undef M_SQRTPI
 #define M_SQRTPI        1.772453850905516027298167483341145182798L
+#endif
+#if defined(M_SQRT3)
+#undef M_SQRT3
 #define M_SQRT3         1.732050807568877293527446341505872366943L
+#endif
 #define M_CBRT2         1.259921049894873164767210607278228350570L
 #define M_CBRT3         1.442249570307408382321638310780109588392L
 #define M_CBRT4         1.587401051968199474751705639272308260391L
diff -buprN -x CYGWIN-PATCHES -x aclocal.m4~ -x aclocal.m4t -x autom4te.cache -x config.cache -x config.guess -x config.log -x config.status -x config.sub -x '*SlackBuild*' -x '*.egg-info' -x '*.dll' -x '*.exe' -x '*.o' -x '*.gch' -x '*.gem' -x .gitignore -x '*.jpg' -x '*.png' -x '*.qm' -x '*.svgz' -x '*.tif' -x '*.class' -x '*.jlc' -x '*.pyc' -x '*.pyo' -x '*.mo' -x '*.gmo' -x '*.orig' -x '*.rej' -x '*.spec' -x '*.temp' -x '*~' -x '*.stackdump' -x x86_64-pc-cygwin -x aclocal.m4 -x configure -x config.h -x '*.h.in' -x COPYING -x INSTALL -x ansi2knr.c -x ar-lib -x config-ml.in -x elisp-comp -x mdate-sh -x mkinstalldirs -x py-compile -x symlink-tree -x test-driver -x texinfo.tex -x ylwrap -x Makefile.in -x GNUmakefile.in -x makefile.in -x libtool.m4 -x ltoptions.m4 -x ltsugar.m4 -x ltversion.m4 -x lt~obsolete.m4 -x ltmain.sh -x compile -x depcomp -x install-sh -x missing -x omf.make -x xmldocs.make -x gnome-doc-utils.make -x gnome-doc-utils.m4 -x mate-doc-utils.make -x mate-doc-utils.m4 origsrc/libxc-4.1.1-c51bdeca70eb3a74ba99f6d1ef8adb4fb2f2a0de/testsuite/Makefile.am src/libxc-4.1.1-c51bdeca70eb3a74ba99f6d1ef8adb4fb2f2a0de/testsuite/Makefile.am
--- origsrc/libxc-4.1.1-c51bdeca70eb3a74ba99f6d1ef8adb4fb2f2a0de/testsuite/Makefile.am	2018-05-09 16:45:21.000000000 +0900
+++ src/libxc-4.1.1-c51bdeca70eb3a74ba99f6d1ef8adb4fb2f2a0de/testsuite/Makefile.am	2018-05-21 09:46:05.866985600 +0900
@@ -12,18 +12,18 @@ SUBDIRS = pytest
 noinst_PROGRAMS = xc-get_data xc-consistency xc-regression xc-error
 dist_noinst_SCRIPTS = xc-run_testsuite xc-reference.pl
 TESTS = xc-run_testsuite
-TESTS_ENVIRONMENT = buildir=$(top_builddir)/testsuite
+TESTS_ENVIRONMENT = buildir=$(top_builddir)/testsuite srcdir=$(srcdir)
 
 xc_get_data_SOURCES = xc-get_data.c
-xc_get_data_LDADD = -L../src/ -lxc -lm
+xc_get_data_LDADD = $(top_builddir)/src/libxc.la -lm
 xc_get_data_CPPFLAGS = -I$(srcdir)/../src/ -I$(top_builddir)/src
 
 xc_consistency_SOURCES = xc-consistency.c
-xc_consistency_LDADD = -L../src/ -lxc -lm
+xc_consistency_LDADD = $(top_builddir)/src/libxc.la -lm
 xc_consistency_CPPFLAGS = -I$(srcdir)/../src/ -I$(top_builddir)/src
 
 xc_regression_SOURCES = xc-regression.c
-xc_regression_LDADD = -L../src/ -lxc -lm
+xc_regression_LDADD = $(top_builddir)/src/libxc.la -lm
 xc_regression_CPPFLAGS = -I$(srcdir)/../src/ -I$(top_builddir)/src
 
 xc_error_SOURCES = xc-error.c
